import{Ab as l,Db as h,I as n,K as c,N as u,ec as s,i as a,k as f,o as i,w as p}from"./chunk-IU75DD4N.js";function g(o){let e=document.cookie.match(new RegExp("(^| )"+o+"=([^;]+)"));return e?decodeURIComponent(e[2]):null}var m=class o{constructor(e){this.http=e}tokenKey="staffToken";expKey="staffExp";profileKey="staffProfile";token$=new a(localStorage.getItem(this.tokenKey));profile$=new a(localStorage.getItem(this.profileKey)?JSON.parse(localStorage.getItem(this.profileKey)):null);get profile(){return this.profile$.value}get token(){return this.token$.value}get userId(){let e=this.token;if(!e)return null;try{let t=d(e),r=t.sub||t.nameid||t["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"];return r?Number(r):null}catch(t){return console.error("[AuthService] Token decode hatas\u0131:",t),null}}get isLoggedIn(){let e=this.token,t=localStorage.getItem(this.expKey);return!e||!t?!1:new Date(t)>new Date}hasAnyRole(e){let t=this.profile;return t?e.some(r=>r.toLowerCase()===(t.role||"").toLowerCase()):!1}login(e,t){return this.http.post(`${s.apiUrl}/api/staff/auth/login`,{email:e,password:t},{withCredentials:!0}).pipe(n(r=>this.setSession(r)),i(r=>r.profile))}refresh(){let e=g("XSRF-TOKEN"),t=e?new l({"X-XSRF-TOKEN":e}):new l;return this.http.post(`${s.apiUrl}/api/staff/auth/refresh`,{},{withCredentials:!0,headers:t}).pipe(n(r=>this.setSession(r)),i(r=>r.token))}logout(){return this.http.post(`${s.apiUrl}/api/staff/auth/logout`,{},{withCredentials:!0}).pipe(n(()=>this.clearSession()),i(()=>{}),p(e=>(this.clearSession(),f(void 0))))}setSession(e){localStorage.setItem(this.tokenKey,e.token),localStorage.setItem(this.expKey,e.expiresAt),localStorage.setItem(this.profileKey,JSON.stringify(e.profile)),this.token$.next(e.token),this.profile$.next(e.profile),console.log("[AuthService] \u{1F510} Oturum kaydedildi:",e.profile?.email)}clearSession(){localStorage.removeItem(this.tokenKey),localStorage.removeItem(this.expKey),localStorage.removeItem(this.profileKey),this.token$.next(null),this.profile$.next(null),console.log("[AuthService] \u{1F6AA} Oturum temizlendi.")}redirectAfterLogin(){switch(this.profile?.role?.toLowerCase()){case"agent":case"teamleader":return"/agent";case"supervisor":return"/staff/supervisor";case"salesmanager":return"/staff/management";case"admin":return"/admin";case"customer":return"/customer";default:return"/login"}}static \u0275fac=function(t){return new(t||o)(u(h))};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};function d(o){try{let e=o.split(".")[1];return JSON.parse(atob(e))}catch(e){throw new Error("JWT parse edilemedi")}}export{m as a};
