import{a as E}from"./chunk-A35KAJYI.js";import{G as l,K as T,N as c,ac as d,ec as i,i as f,l as s,u as p,w as a,z as R}from"./chunk-IU75DD4N.js";var g=class n{constructor(e,r){this.auth=e;this.router=r}isRefreshing=!1;refreshTokenSubject=new f(null);intercept(e,r){let t=this.auth.token,o=e;console.log("%c[STAFF INTERCEPTOR] Aktif","color: cyan; font-weight: bold;"),console.log("[STAFF INTERCEPTOR] Gelen istek:",e.url);let u=e.url.startsWith(`${i.apiUrl}/api/staff`)||e.url.startsWith(`${i.apiUrl}/api/agent`)||e.url.startsWith(`${i.apiUrl}/api/admin`);return u?!u&&!e.url.includes("/auth/")?(console.log("[STAFF INTERCEPTOR] Bu istek staff ile ilgili de\u011Fil, pas ge\xE7iliyor."),r.handle(e)):(e.url.includes("/auth/refresh")?(console.log("[STAFF INTERCEPTOR] Refresh request \u2192 sadece cookie ile gidiyor"),o=e.clone({withCredentials:!0})):t?(console.log("[STAFF INTERCEPTOR] Token bulundu, header eklendi"),o=e.clone({setHeaders:{Authorization:`Bearer ${t}`,"Cache-Control":"no-cache",Pragma:"no-cache"}})):(console.warn("[STAFF INTERCEPTOR] Token yok \u2192 \xE7\u0131plak request gidiyor:",e.url),o=e.clone({setHeaders:{"Cache-Control":"no-cache",Pragma:"no-cache"}})),r.handle(o).pipe(a(h=>h.status===401&&!e.url.includes("/auth/login")&&!e.url.includes("/auth/refresh")?(console.warn("[STAFF INTERCEPTOR] 401 yakaland\u0131, refresh denenecek:",e.url),this.handle401Error(o,r)):s(()=>h)))):r.handle(e)}handle401Error(e,r){return this.isRefreshing?(console.log("[STAFF INTERCEPTOR] Refresh zaten \xE7al\u0131\u015F\u0131yor, bekleniyor..."),this.refreshTokenSubject.pipe(p(t=>t!==null),R(1),l(t=>{console.log("[STAFF INTERCEPTOR] Beklenen refresh tamamland\u0131, istek tekrar g\xF6nderiliyor");let o=e.clone({setHeaders:{Authorization:`Bearer ${t}`}});return r.handle(o)}))):(this.isRefreshing=!0,this.refreshTokenSubject.next(null),console.log("[STAFF INTERCEPTOR] Refresh ba\u015Flat\u0131l\u0131yor..."),this.auth.refresh().pipe(l(t=>{this.isRefreshing=!1,console.log("[STAFF INTERCEPTOR] Refresh ba\u015Far\u0131l\u0131, yeni token al\u0131nd\u0131:",t),this.refreshTokenSubject.next(t);let o=e.clone({setHeaders:{Authorization:`Bearer ${t}`}});return r.handle(o)}),a(t=>(console.error("[STAFF INTERCEPTOR] Refresh ba\u015Far\u0131s\u0131z \u2192 logout ediliyor"),this.isRefreshing=!1,this.auth.logout().subscribe(()=>this.router.navigate(["/login"])),s(()=>t)))))}static \u0275fac=function(r){return new(r||n)(c(E),c(d))};static \u0275prov=T({token:n,factory:n.\u0275fac})};export{g as a};
